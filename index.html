<script>

/* ================= CAMERA ================= */

let scale=1,posX=0,posY=0;
let dragging=false,lastX=0,lastY=0;

const world=document.getElementById("map-world");
const viewport=document.getElementById("map-container");

function updateTransform(){
world.style.transform=`translate(${posX}px,${posY}px) scale(${scale})`;
buildRoutes();
}

/* ZOOM */

viewport.addEventListener("wheel",e=>{
e.preventDefault();
scale+=e.deltaY<0?0.1:-0.1;
scale=Math.max(.6,Math.min(2.5,scale));
updateTransform();
},{passive:false});

/* DRAG */

viewport.addEventListener("mousedown",e=>{
dragging=true;
lastX=e.clientX;
lastY=e.clientY;
});

window.addEventListener("mouseup",()=>dragging=false);

window.addEventListener("mousemove",e=>{
if(!dragging)return;
posX+=e.clientX-lastX;
posY+=e.clientY-lastY;
lastX=e.clientX;
lastY=e.clientY;
updateTransform();
});

/* ================= ROUTES ================= */

const routesSVG=document.getElementById("routes-layer");

function buildRoutes(){

routesSVG.innerHTML="";

const planets=document.querySelectorAll(".planet");
const rect=viewport.getBoundingClientRect();

const points=[];

planets.forEach(p=>{

const x=parseFloat(p.style.left)/100*rect.width;
const y=parseFloat(p.style.top)/100*rect.height;

points.push({x,y});

});

for(let i=0;i<points.length;i++){
for(let j=i+1;j<points.length;j++){

const dx=points[i].x-points[j].x;
const dy=points[i].y-points[j].y;
const dist=Math.sqrt(dx*dx+dy*dy);

if(dist<220){

const line=document.createElementNS("http://www.w3.org/2000/svg","line");

line.setAttribute("x1",points[i].x);
line.setAttribute("y1",points[i].y);
line.setAttribute("x2",points[j].x);
line.setAttribute("y2",points[j].y);

line.classList.add("route-line");
routesSVG.appendChild(line);
}
}
}

}

/* ================= INFO PANEL ================= */

function selectPlanet(el){

const p=el.closest(".planet");

let img="";

if(p.dataset.image){
img=`<img src="static/${p.dataset.image}" class="info-image">`;
}

document.getElementById("info").innerHTML=`
${img}
<h3>${p.dataset.name}</h3>
<b>Faction:</b> ${p.dataset.faction}<br><br>
${p.dataset.desc}<br><br>
<a href="${p.dataset.wiki}" target="_blank">Open Wiki</a>
`;

}

/* ================= ROUTE TOGGLE ================= */

let routesVisible=true;

document.getElementById("route-toggle").onclick=()=>{

routesVisible=!routesVisible;
routesSVG.style.display=routesVisible?"block":"none";

};

/* ================= LOAD DATA ================= */

fetch("data.json")
.then(r=>r.json())
.then(planetes=>{

planetes.forEach(p=>{

const planet=document.createElement("div");
planet.className="planet "+p.Faction.toLowerCase();

planet.style.left=p.X+"%";
planet.style.top=p.Y+"%";

planet.dataset.name=p.Planete;
planet.dataset.faction=p.Faction;
planet.dataset.desc=p.Description;
planet.dataset.wiki=p.Wiki;
planet.dataset.image=p.Image || "";

/* DOT */

planet.innerHTML=`<div class="dot" onclick="selectPlanet(this)"></div>`;

/* PATROL SHIPS */

for(let i=0;i<(p.PatrolCount||0);i++){

planet.innerHTML+=`
<img src="static/patrol_ship.png"
class="ship-icon"
style="--i:${i}">
`;
}

/* CAPITAL SHIPS */

for(let i=0;i<(p.CapitalShip||0);i++){

planet.innerHTML+=`
<img src="static/capital_ship.png"
class="capital-ship">
`;
}

/* LABEL */

planet.innerHTML+=`<div class="label">${p.Planete}</div>`;

world.appendChild(planet);

});

buildRoutes();

});
</script>
